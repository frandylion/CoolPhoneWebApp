<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome back to CoolPhoneApp!</title>
    <script>

        async function getBills() {
            const response = await fetch(`http://localhost:3000/userBills`);
            const data = await response.json();
            const due_balance = data.dueBalance;
            const bill_rows = data.userBills;

            // display balance
            const balanceElement = document.getElementById('dueBalance');
            balanceElement.textContent = `Outstanding balance: $${Number(due_balance).toFixed(2)}`;

            // display bills table
            const table = document.getElementById('billTableBody');
            table.innerHTML = '';

            for (bill of bill_rows) {
                const row = `
                    <tr>
                        <td>${bill.bill_id}</td>
                        <td>$${Number(bill.cost).toFixed(2)}</td>
                        <td>${Number(bill.total_minutes).toFixed(2)}</td>
                        <td>${bill.data_used_mib}</td>
                        <td>${bill.due_date.split('T')[0]}</td>
                        <td>${bill.paid}</td>
                    </tr>
                `;
                table.innerHTML += row;
            }
        }

        async function getTransactions() {
            const response = await fetch(`http://localhost:3000/userTransactions`);
            const transaction_rows = await response.json();

            // display transactions table
            const table = document.getElementById('transactionTableBody');
            table.innerHTML = '';

            for (transaction of transaction_rows) {
                const row = `
                    <tr>
                        <td>${transaction.bill_id}</td>
                        <td>$${Number(transaction.cost).toFixed(2)}</td>
                        <td>${transaction.date_paid.split('T')[0]}</td>
                        <td>${transaction.due_date.split('T')[0]}</td>
                    </tr>
                `;
                table.innerHTML += row;
            }
        }

        // async function makePayment() {
        //     const paymentAmount = document.getElementById('paymentAmount').value;
        //     const user_id = await getUser().user_id;

        //     const response = await fetch('http://localhost:3000/make_payment', {
        //         method: 'POST',
        //         headers: {'Content-Type': 'application/json'},
        //         body: JSON.stringify({payment_amount: parseFloat(paymentAmount)})
        //     });

        //     const result = await response.json();
        //     document.getElementById('paymentStatus').textContent = result.message;
        //     getTransactions();
        //     getUserTotalAmount();
        // }

        // async function getCallLog() {
        //     const response = await fetch(`http://localhost:3000/call_log`);
        //     const calls = await response.json();
        //     const table = document.getElementById('callTable');
        //     table.innerHTML = '';

        //     calls.forEach(call_log => {
        //         const row = `
        //             <tr>
        //                 <td>${call_log.user_id}</td>
        //                 <td>${call_log.call_id}</td>
        //                 <td>${call_log.duration}</td>
        //                 <td>${call_log.call_date_time}</td>
        //                 <td>${call_log.call_type}</td>
        //              </tr>
        //         `;
        //         table.innerHTML += row;
        //     });
        // }

        async function welcome() {
            const user_json = await getUser();
            const first_name = user_json.first_name;
            const last_name = user_json.last_name;

            const message = document.getElementById('welcomeMessage');
            message.textContent = `Welcome back, ${first_name} ${last_name}!`;
        }

        async function getUser() {
            const response = await fetch(`http://localhost:3000/user`);
            return await response.json();
        }

        window.onload = function() {
            welcome();
            getBills();
            getTransactions();
            // getCallLog();
        };
    </script>
</head>
<body>

    <h1 id="welcomeMessage">Welcome back, !</h1>

    <hr>

    <h2 id="dueBalance">Outstanding balance: $0.00</h2>
    <h3>Bills</h3>
    <table border="1">
        <thead>
            <tr>
                <th>Bill ID</th>
                <th>Amount</th>
                <th>Call Minutes</th>
                <th>MiB Data Used</th>
                <th>Date Due</th>
                <th>Paid</th>
            </tr>
        </thead>
        <tbody id="billTableBody"></tbody>
    </table>
    <button type="button" onClick="payBalance()">Pay Balance</button>

    <br>
    <br>

    <h3>Transaction History</h3>
    <table border="1">
        <thead>
            <tr>
                <th>Bill ID</th>
                <th>Amount</th>
                <th>Date Paid</th>
                <th>Date Due</th>
            </tr>
        </thead>
        <tbody id="transactionTableBody"></tbody>
    </table>

    <!-- <form id="paymentForm">
        <label htmlFor="paymentAmount">Payment Amount:</label>
        <input type="number" id="paymentAmount" name="paymentAmount" required>
        <button type="button" onClick="makePayment()">Submit Payment</button>
    </form> -->

    <!-- <p id="paymentStatus"></p>
    <table border="1">
        <thead>
            <tr>
                <th>User ID</th>
                <th>Call ID</th>
                <th>Duration</th>
                <th>Date</th>
                <th>call type</th>
            </tr>
        </thead>
        <tbody id="callTable"></tbody>
    </table> -->

</body>
</html>
